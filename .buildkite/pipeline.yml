# SPDX-FileCopyrightText: 2020 TBD
# SPDX-License-Identifier: LicenseRef-Proprietary

steps:
  - label: hlint
    branches: "!autodoc/master"
    commands:
    - nix run -f ci.nix pkgs.hlint -c
        ./scripts/lint.sh

  - label: reuse lint
    branches: "!autodoc/master"
    commands:
    - nix run -f ci.nix pkgs.reuse -c
        reuse lint

  - label: check trailing whitespace
    branches: "!autodoc/master"
    commands:
    - .buildkite/check-trailing-whitespace.sh

  - label: xrefcheck
    branches: "!autodoc/master"
    commands:
    - nix run -f ci.nix xrefcheck -c xrefcheck
    soft_fail: true  # TODO: remove

  - label: build
    branches: "!autodoc/master"
    commands:
    - nix-build ci.nix -A all-components

  - label: test
    branches: "!autodoc/master"
    commands:
    - nix-build ci.nix -A packages.globacap.tests.globacap-test
    - ./result/bin/globacap-test

  - label: weeder
    branches: "!autodoc/master"
    commands:
    - nix-build ci.nix -A weeder-script
      # weeder needs .cabal file:
    - nix run -f ci.nix pkgs.haskellPackages.hpack -c hpack
    - ./result
